"""
RMAV Desktop - MangoDefend Style UI
Exact replica of Frontend/gui design
"""
from PySide6.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QLabel, QFileDialog, QFrame, QScrollArea,
    QMessageBox, QGraphicsOpacityEffect, QProgressBar, QSizePolicy
)
from PySide6.QtCore import (
    Qt, QThread, Signal, QPropertyAnimation, QEasingCurve,
    QTimer, QRect, QSize
)
from PySide6.QtGui import (
    QDragEnterEvent, QDropEvent, QFont, QPainter,
    QLinearGradient, QColor, QPen, QBrush, QPixmap
)
from pathlib import Path
from datetime import datetime


from core.scanner import MalwareScanner


# ============= SIMPLE NAVBAR =============
class SimpleNavbar(QWidget):
    """Navbar simple dengan logo"""
    
    # Signals
    menu_clicked = Signal()
    dark_mode_toggled = Signal(bool)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setFixedHeight(70)
        self.is_dark_mode = False
        self.setup_ui()
        
    def setup_ui(self):
        layout = QHBoxLayout(self)
        layout.setContentsMargins(20, 10, 20, 10)
        layout.setSpacing(20)
        
        # Menu button (hamburger icon)
        self.menu_btn = QPushButton("‚ò∞")
        self.menu_btn.setObjectName("navMenuButton")
        self.menu_btn.setFixedSize(50, 50)
        self.menu_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.menu_btn.clicked.connect(lambda: self.menu_clicked.emit())
        layout.addWidget(self.menu_btn)
        
        # Logo di tengah
        layout.addStretch()
        
        self.logo_label = QLabel()
        self.logo_label.setObjectName("navLogo")
        self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        # Load gambar dengan aspect ratio yang benar
        pixmap = QPixmap("assets/mango_icon.png")  # GANTI PATH INI sesuai lokasi gambar kamu
        
        # Pakai scaled() dengan KeepAspectRatio supaya gak kepotong
        scaled_pixmap = pixmap.scaled(
            230, 60,  # width, height maksimal
            Qt.AspectRatioMode.KeepAspectRatio,  # jaga proporsi
            Qt.TransformationMode.SmoothTransformation  # smooth scaling
        )
        self.logo_label.setPixmap(scaled_pixmap)
        
        layout.addWidget(self.logo_label)
        layout.addStretch()
        
        # Dark mode toggle button (kanan)
        self.dark_mode_btn = QPushButton("üåô")
        self.dark_mode_btn.setObjectName("navDarkButton")
        self.dark_mode_btn.setFixedSize(50, 50)
        self.dark_mode_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.dark_mode_btn.clicked.connect(self.toggle_dark_mode)
        layout.addWidget(self.dark_mode_btn)
        
        self.apply_style()
    
    def toggle_dark_mode(self):
        """Toggle dark mode dan emit signal"""
        self.is_dark_mode = not self.is_dark_mode
        
        if self.is_dark_mode:
            self.dark_mode_btn.setText("‚òÄÔ∏è")
        else:
            self.dark_mode_btn.setText("üåô")
        
        self.apply_style(self.is_dark_mode)
        self.dark_mode_toggled.emit(self.is_dark_mode)
    
    def apply_style(self, is_dark=False):
        """Apply navbar style"""
        self.is_dark_mode = is_dark
        
        if is_dark:
            self.setStyleSheet("""
                QWidget {
                    background: rgba(30, 30, 30, 0.95);
                }
                QLabel#navLogo {
                    background: transparent;
                    border: none;
                }
                QPushButton#navMenuButton, QPushButton#navDarkButton {
                    background: rgba(50, 50, 50, 0.8);
                    border: 2px solid #FFA500;
                    border-radius: 25px;
                    color: #FFA500;
                    font-size: 22px;
                    font-weight: bold;
                }
                QPushButton#navMenuButton:hover, QPushButton#navDarkButton:hover {
                    background: rgba(255, 165, 0, 0.3);
                    border: 2px solid #FFB732;
                }
            """)
        else:
            self.setStyleSheet("""
                QWidget {
                    background: rgba(255, 255, 255, 0.95);
                }
                QLabel#navLogo {
                    background: transparent;
                    border: none;
                }
                QPushButton#navMenuButton, QPushButton#navDarkButton {
                    background: rgba(255, 250, 240, 0.8);
                    border: 2px solid #FF8C00;
                    border-radius: 25px;
                    color: #FF8C00;
                    font-size: 22px;
                    font-weight: bold;
                }
                QPushButton#navMenuButton:hover, QPushButton#navDarkButton:hover {
                    background: rgba(255, 140, 0, 0.2);
                    border: 2px solid #FFA500;
                }
            """)


class ScanThread(QThread):
    """Thread for running malware scan"""
    finished = Signal(dict)
    error = Signal(str)
    progress = Signal(int, str)


    def __init__(self, file_path):
        super().__init__()
        self.file_path = file_path
        self.scanner = MalwareScanner()
        self.is_canceled = False


    def run(self):
        try:
            # Simulate progress stages
            stages = [
                (10, "Memulai pemindaian..."),
                (25, "Menganalisis file..."),
                (40, "Memproses dengan AI..."),
                (60, "Mendeteksi malware..."),
                (80, "Menyelesaikan analisis..."),
                (95, "Hampir selesai...")
            ]


            for value, message in stages:
                if self.is_canceled:
                    return
                self.progress.emit(value, message)
                self.msleep(200)


            result = self.scanner.scan_file(self.file_path)
            self.progress.emit(100, "Selesai!")
            self.msleep(200)
            self.finished.emit(result)


        except Exception as e:
            self.error.emit(str(e))


    def cancel(self):
        self.is_canceled = True



class AnimatedSpinner(QWidget):
    """Custom animated spinner widget"""
    def __init__(self, diameter=80, line_width=6, parent=None):
        super().__init__(parent)
        self.diameter = diameter
        self.line_width = line_width
        self.angle = 0
        self.setFixedSize(diameter, diameter)


        self.timer = QTimer(self)
        self.timer.timeout.connect(self._rotate)
        self.timer.start(16)  # ~60fps


    def _rotate(self):
        self.angle = (self.angle + 6) % 360
        self.update()


    def paintEvent(self, event):
        painter = QPainter(self)
        painter.setRenderHint(QPainter.RenderHint.Antialiasing)


        rect = self.rect()
        margin = self.line_width


        # Background circle
        back_pen = QPen(QColor(255, 255, 255, 80), self.line_width)
        back_pen.setCapStyle(Qt.PenCapStyle.RoundCap)
        painter.setPen(back_pen)
        painter.drawArc(
            rect.adjusted(margin, margin, -margin, -margin),
            0, 360 * 16
        )


        # Animated arc
        arc_pen = QPen(QColor(255, 140, 0), self.line_width)
        arc_pen.setCapStyle(Qt.PenCapStyle.RoundCap)
        painter.setPen(arc_pen)
        span_angle = 120 * 16
        painter.drawArc(
            rect.adjusted(margin, margin, -margin, -margin),
            int(self.angle * 16), span_angle
        )



class ScanningDialog(QWidget):
    """Scanning overlay with mango theme"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setObjectName("scanningOverlay")
        self.setAttribute(Qt.WidgetAttribute.WA_StyledBackground, True)
        self._cancel_callback = None
        self.setup_ui()


    def setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setAlignment(Qt.AlignmentFlag.AlignCenter)


        # Card container
        card = QFrame()
        card.setObjectName("spinnerContainer")
        card_layout = QVBoxLayout(card)
        card_layout.setContentsMargins(40, 40, 40, 40)
        card_layout.setSpacing(20)
        card_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)


        # Animated spinner
        self.spinner = AnimatedSpinner()
        card_layout.addWidget(self.spinner, alignment=Qt.AlignmentFlag.AlignCenter)


        # Title
        self.title_label = QLabel("Memindai File")
        self.title_label.setObjectName("spinnerTitle")
        self.title_label.setFont(QFont("Arial", 20, QFont.Weight.Bold))
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        card_layout.addWidget(self.title_label)


        # Status
        self.status_label = QLabel("Menyiapkan...")
        self.status_label.setObjectName("statusText")
        self.status_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.status_label.setWordWrap(True)
        card_layout.addWidget(self.status_label)


        # Progress bar
        self.progress_bar = QProgressBar()
        self.progress_bar.setRange(0, 100)
        self.progress_bar.setValue(0)
        self.progress_bar.setTextVisible(True)
        self.progress_bar.setFixedHeight(24)
        card_layout.addWidget(self.progress_bar)


        # Cancel button
        self.cancel_btn = QPushButton("Batalkan")
        self.cancel_btn.setObjectName("cancelScanButton")
        self.cancel_btn.clicked.connect(self._handle_cancel)
        btn_layout = QHBoxLayout()
        btn_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        btn_layout.addWidget(self.cancel_btn)
        card_layout.addLayout(btn_layout)


        layout.addWidget(card)


        self.apply_style()


    def apply_style(self, is_dark=False):
        if is_dark:
            self.setStyleSheet("""
                QWidget#scanningOverlay {
                    background: rgba(0, 0, 0, 180);
                }
                QFrame#spinnerContainer {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 #252525, stop:0.5 #1F1F1F, stop:1 #1A1A1A);
                    border: 4px solid #FFA500;
                    border-radius: 35px;
                    padding: 10px;
                }
                QLabel#spinnerTitle {
                    color: #FFA500;
                    font-weight: 700;
                    font-size: 22px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QLabel#statusText {
                    color: #CCCCCC;
                    font-size: 15px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QProgressBar {
                    border: 3px solid #FFA500;
                    border-radius: 14px;
                    color: #FFA500;
                    text-align: center;
                    font-weight: 600;
                    font-size: 13px;
                    background: rgba(30, 30, 30, 0.8);
                }
                QProgressBar::chunk {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                        stop:0 #FFA500, stop:0.5 #FF8C00, stop:1 #FF7F00);
                    border-radius: 11px;
                }
                QPushButton#cancelScanButton {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #FF6B35, stop:1 #E64A19);
                    color: white;
                    border: 2px solid #FF8C00;
                    padding: 12px 28px;
                    border-radius: 22px;
                    font-weight: 600;
                    font-size: 14px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QPushButton#cancelScanButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #E64A19, stop:1 #D84315);
                    border: 2px solid #FFA500;
                }
            """)
        else:
            self.setStyleSheet("""
                QWidget#scanningOverlay {
                    background: rgba(0, 0, 0, 150);
                }
                QFrame#spinnerContainer {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 #FFFFFF, stop:0.5 #FFF5E6, stop:1 #FFE4B5);
                    border: 4px solid #FF8C00;
                    border-radius: 35px;
                    padding: 10px;
                }
                QLabel#spinnerTitle {
                    color: #2C2C2C;
                    font-weight: 700;
                    font-size: 22px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QLabel#statusText {
                    color: #444444;
                    font-size: 15px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QProgressBar {
                    border: 3px solid #FF8C00;
                    border-radius: 14px;
                    color: #2C2C2C;
                    text-align: center;
                    font-weight: 600;
                    font-size: 13px;
                    background: rgba(255, 255, 255, 0.8);
                }
                QProgressBar::chunk {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                        stop:0 #FFA500, stop:0.5 #FF8C00, stop:1 #FF7F00);
                    border-radius: 11px;
                }
                QPushButton#cancelScanButton {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #FF6B35, stop:1 #E64A19);
                    color: white;
                    border: 2px solid #FF8C00;
                    padding: 12px 28px;
                    border-radius: 22px;
                    font-weight: 600;
                    font-size: 14px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                QPushButton#cancelScanButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #E64A19, stop:1 #D84315);
                    border: 2px solid #FFA500;
                }
            """)


    def set_cancel_callback(self, callback):
        self._cancel_callback = callback


    def _handle_cancel(self):
        if self._cancel_callback:
            self._cancel_callback()


    def update_progress(self, value, message):
        self.progress_bar.setValue(value)
        self.status_label.setText(message)


    def start(self):
        if self.parent():
            self.setGeometry(self.parent().rect())
        self.show()
        self.raise_()


    def finish(self):
        self.hide()



class ResultDialog(QWidget):
    """Custom result dialog dengan desain modern, smooth dan elegan"""
    def __init__(self, result_data, parent=None):
        super().__init__(parent)
        self.result_data = result_data
        self.setObjectName("resultOverlay")
        self.setAttribute(Qt.WidgetAttribute.WA_StyledBackground, True)
        self.setup_ui()
        self._animate_entry()


    def setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setAlignment(Qt.AlignmentFlag.AlignCenter)


        # Determine result type
        result_type = self.result_data['result']
        is_safe = result_type == "Benign"
        predicted_output = self.result_data['model']['predicted_output']

        # Handle different output formats (ONNX vs PyTorch)
        if isinstance(predicted_output, list):
            # Already a list (ONNX format or PyTorch format)
            if len(predicted_output) == 2:
                # Direct probabilities [benign, malware]
                probs = predicted_output
            else:
                # Nested list [[benign, malware]]
                probs = predicted_output[0] if isinstance(predicted_output[0], list) else predicted_output
        else:
            # Single value or other format
            probs = [predicted_output, 1 - predicted_output]

        # Calculate confidence using softmax-like normalization
        # Convert logits to probabilities if needed
        import math
        exp_probs = [math.exp(p) if p < 100 else math.exp(min(p, 100)) for p in probs]
        total = sum(exp_probs)

        if total > 0:
            probabilities = [p / total for p in exp_probs]
            confidence = max(probabilities)
        else:
            confidence = 0.5

        # Pastikan tidak melebihi 100%
        confidence = min(confidence, 1.0)


        # Card container
        card = QFrame()
        card.setObjectName("resultContainer")
        card_layout = QVBoxLayout(card)
        card_layout.setContentsMargins(0, 0, 0, 0)
        card_layout.setSpacing(0)


        # === HEADER SECTION - Status Banner ===
        header = QFrame()
        header.setObjectName("resultHeader")
        header_layout = QVBoxLayout(header)
        header_layout.setContentsMargins(35, 30, 35, 30)
        header_layout.setSpacing(12)


        # Status icon dan title
        status_row = QHBoxLayout()
        status_row.setSpacing(15)
        status_row.setAlignment(Qt.AlignmentFlag.AlignCenter)


        icon_text = "!" if not is_safe else "‚úì"
        status_icon = QLabel(icon_text)
        status_icon.setFixedSize(50, 50)
        status_icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        status_icon.setStyleSheet(f"""
            font-size: 32px;
            font-weight: bold;
            color: white;
            background: {'rgba(50, 205, 50, 1)' if is_safe else 'rgba(239, 68, 68, 1)'};
            border-radius: 25px;
        """)
        status_row.addWidget(status_icon)


        # Title
        title_text = "File Aman" if is_safe else "Terdeteksi Ancaman"
        title_label = QLabel(title_text)
        title_label.setStyleSheet("""
            font-size: 24px;
            font-weight: 600;
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
        """)
        status_row.addWidget(title_label)
        status_row.addStretch()


        header_layout.addLayout(status_row)


        # Subtitle dengan confidence yang sudah diperbaiki
        subtitle = QLabel(f"Pemindaian selesai dengan tingkat keyakinan {confidence:.0%}")
        subtitle.setStyleSheet("""
            font-size: 13px;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Segoe UI', Arial, sans-serif;
            padding-left: 65px;
        """)
        header_layout.addWidget(subtitle)


        # Style header - konsisten warna mango/orange
        header.setStyleSheet(f"""
            QFrame#resultHeader {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {'#32CD32' if is_safe else '#FF8C00'}, 
                    stop:1 {'#90EE90' if is_safe else '#FFA500'});
                border-radius: 20px 20px 0 0;
            }}
        """)
        card_layout.addWidget(header)


        # === CONTENT SECTION ===
        content = QWidget()
        content_layout = QVBoxLayout(content)
        content_layout.setContentsMargins(35, 30, 35, 30)
        content_layout.setSpacing(20)


        # File Info Card
        file_card = QFrame()
        file_card.setObjectName("infoCard")
        file_layout = QVBoxLayout(file_card)
        file_layout.setContentsMargins(20, 16, 20, 16)
        file_layout.setSpacing(8)


        file_header = QLabel("üìÑ INFORMASI FILE")
        file_header.setStyleSheet("""
            font-size: 11px;
            font-weight: 600;
            color: #6B7280;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.5px;
        """)
        file_layout.addWidget(file_header)


        # File name
        file_name = QLabel(self.result_data['file']['file_name'])
        file_name.setWordWrap(True)
        file_name.setMaximumWidth(480)
        file_name.setStyleSheet("""
            font-size: 14px;
            font-weight: 500;
            color: #1F2937;
            font-family: 'Courier New', monospace;
            padding: 4px 0;
        """)
        file_layout.addWidget(file_name)


        file_card.setStyleSheet("""
            QFrame#infoCard {
                background: #F9FAFB;
                border: 1px solid #E5E7EB;
                border-radius: 12px;
            }
        """)
        content_layout.addWidget(file_card)


        # Detection Result Card - warna konsisten
        detect_card = QFrame()
        detect_card.setObjectName("detectCard")
        detect_layout = QVBoxLayout(detect_card)
        detect_layout.setContentsMargins(20, 16, 20, 16)
        detect_layout.setSpacing(8)


        detect_header = QLabel("üîç HASIL DETEKSI")
        detect_header.setStyleSheet("""
            font-size: 11px;
            font-weight: 600;
            color: #6B7280;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.5px;
        """)
        detect_layout.addWidget(detect_header)


        detect_value = QLabel(result_type)
        detect_value.setStyleSheet(f"""
            font-size: 20px;
            font-weight: 700;
            color: {'#32CD32' if is_safe else '#FF8C00'};
            font-family: 'Segoe UI', Arial, sans-serif;
        """)
        detect_layout.addWidget(detect_value)


        detect_card.setStyleSheet(f"""
            QFrame#detectCard {{
                background: {'rgba(144, 238, 144, 0.2)' if is_safe else 'rgba(255, 165, 0, 0.15)'};
                border: 2px solid {'rgba(50, 205, 50, 0.4)' if is_safe else 'rgba(255, 140, 0, 0.5)'};
                border-radius: 12px;
            }}
        """)
        content_layout.addWidget(detect_card)


        # Confidence Meter - warna konsisten
        confidence_section = QVBoxLayout()
        confidence_section.setSpacing(12)


        conf_label = QLabel("TINGKAT KEYAKINAN")
        conf_label.setStyleSheet("""
            font-size: 11px;
            font-weight: 600;
            color: #6B7280;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.5px;
        """)
        confidence_section.addWidget(conf_label)


        # Progress bar container
        conf_container = QHBoxLayout()
        conf_container.setSpacing(15)


        conf_bar = QProgressBar()
        conf_bar.setRange(0, 100)
        conf_bar.setValue(int(confidence * 100))
        conf_bar.setTextVisible(False)
        conf_bar.setFixedHeight(12)
        conf_bar.setStyleSheet(f"""
            QProgressBar {{
                background: #E5E7EB;
                border-radius: 6px;
                border: none;
            }}
            QProgressBar::chunk {{
                background: {'#32CD32' if is_safe else '#FFA500'};
                border-radius: 6px;
            }}
        """)
        conf_container.addWidget(conf_bar, 1)


        conf_percent = QLabel(f"{confidence:.0%}")
        conf_percent.setStyleSheet(f"""
            font-size: 24px;
            font-weight: 700;
            color: {'#32CD32' if is_safe else '#FF8C00'};
            font-family: 'Segoe UI', Arial, sans-serif;
            min-width: 60px;
        """)
        conf_container.addWidget(conf_percent)


        confidence_section.addLayout(conf_container)
        content_layout.addLayout(confidence_section)


        # Warning banner untuk malware - warna konsisten orange
        if not is_safe:
            warning = QFrame()
            warning.setObjectName("warningBanner")
            warn_layout = QHBoxLayout(warning)
            warn_layout.setContentsMargins(16, 14, 16, 14)
            warn_layout.setSpacing(12)


            warn_icon = QLabel("‚ö†")
            warn_icon.setStyleSheet("font-size: 24px; color: #FF8C00;")
            warn_layout.addWidget(warn_icon)


            warn_text = QLabel("Segera hapus file ini untuk melindungi perangkat Anda")
            warn_text.setWordWrap(True)
            warn_text.setStyleSheet("""
                font-size: 13px;
                font-weight: 600;
                color: #CC6600;
                font-family: 'Segoe UI', Arial, sans-serif;
            """)
            warn_layout.addWidget(warn_text, 1)


            warning.setStyleSheet("""
                QFrame#warningBanner {
                    background: rgba(255, 165, 0, 0.1);
                    border-left: 4px solid #FFA500;
                    border-radius: 10px;
                }
            """)
            content_layout.addWidget(warning)


        card_layout.addWidget(content)


        # === FOOTER SECTION ===
        footer = QWidget()
        footer_layout = QHBoxLayout(footer)
        footer_layout.setContentsMargins(35, 20, 35, 30)
        footer_layout.setSpacing(0)


        # Device info
        device_info = QLabel(f"üíª {self.result_data['device']['device_name']}")
        device_info.setStyleSheet("""
            font-size: 12px;
            color: #9CA3AF;
            font-family: 'Segoe UI', Arial, sans-serif;
        """)
        footer_layout.addWidget(device_info)
        footer_layout.addStretch()


        # Close button - warna konsisten
        self.close_btn = QPushButton("Selesai")
        self.close_btn.clicked.connect(self.close_dialog)
        self.close_btn.setFixedSize(100, 40)
        self.close_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        self.close_btn.setStyleSheet(f"""
            QPushButton {{
                background: {'#32CD32' if is_safe else '#FFA500'};
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                font-family: 'Segoe UI', Arial, sans-serif;
            }}
            QPushButton:hover {{
                background: {'#90EE90' if is_safe else '#FFB732'};
            }}
            QPushButton:pressed {{
                background: {'#228B22' if is_safe else '#FF8C00'};
            }}
        """)
        footer_layout.addWidget(self.close_btn)


        card_layout.addWidget(footer)


        layout.addWidget(card)


        # Main container style
        self.setStyleSheet("""
            QWidget#resultOverlay {
                background: rgba(17, 24, 39, 0.85);
            }
            QFrame#resultContainer {
                background: white;
                border-radius: 20px;
                min-width: 550px;
                max-width: 580px;
            }
        """)


    def _animate_entry(self):
        """Animate dialog entry"""
        self.opacity_effect = QGraphicsOpacityEffect(self)
        self.setGraphicsEffect(self.opacity_effect)
        
        self.fade_animation = QPropertyAnimation(self.opacity_effect, b"opacity")
        self.fade_animation.setDuration(300)
        self.fade_animation.setStartValue(0.0)
        self.fade_animation.setEndValue(1.0)
        self.fade_animation.setEasingCurve(QEasingCurve.Type.OutCubic)


    def close_dialog(self):
        """Close dengan fade out"""
        self.fade_out = QPropertyAnimation(self.opacity_effect, b"opacity")
        self.fade_out.setDuration(200)
        self.fade_out.setStartValue(1.0)
        self.fade_out.setEndValue(0.0)
        self.fade_out.setEasingCurve(QEasingCurve.Type.InCubic)
        self.fade_out.finished.connect(self._final_close)
        self.fade_out.start()


    def _final_close(self):
        self.hide()
        self.deleteLater()


    def show_dialog(self):
        if self.parent():
            self.setGeometry(self.parent().rect())
        self.show()
        self.raise_()
        self.fade_animation.start()



class ModernWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.current_file = None
        self.scan_history = []
        self.is_scanning = False
        self.scan_worker = None
        self.scan_dialog = None
        self.result_dialog = None
        self.is_dark_mode = False
        self.init_ui()
        self.apply_mango_theme()


    def init_ui(self):
        self.setWindowTitle("ü•≠ MangoDefend - Pemindai Malware AI")
        self.setGeometry(100, 100, 1000, 700)
        self.setMinimumSize(900, 650)


        # Main container
        central_widget = QWidget()
        self.setCentralWidget(central_widget)


        main_layout = QVBoxLayout()
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)
        central_widget.setLayout(main_layout)

        # === NAVBAR ===
        self.navbar = SimpleNavbar(central_widget)
        self.navbar.menu_clicked.connect(self.show_menu)
        self.navbar.dark_mode_toggled.connect(self.on_dark_mode_toggle)
        main_layout.addWidget(self.navbar)

        # Content area with better padding
        content = QWidget()
        content_layout = QVBoxLayout()
        content_layout.setContentsMargins(60, 30, 60, 60)
        content_layout.setSpacing(40)
        content.setLayout(content_layout)


        # Center content
        center_layout = QVBoxLayout()
        center_layout.setSpacing(25)
        center_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)


        # Scan icon with better size
        self.scan_icon = QLabel("üîç")
        self.scan_icon.setObjectName("scanIcon")
        self.scan_icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.scan_icon.setFixedSize(140, 140)
        center_layout.addWidget(self.scan_icon, alignment=Qt.AlignmentFlag.AlignCenter)


        # Add spacing after icon
        center_layout.addSpacing(10)


        # Title
        title_layout = QHBoxLayout()
        title_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title_layout.setSpacing(5)


        run_label = QLabel("Jalankan ")
        run_label.setObjectName("mainTitle")
        title_layout.addWidget(run_label)


        smart_label = QLabel("Smart")
        smart_label.setObjectName("smartTitle")
        title_layout.addWidget(smart_label)


        scan_label = QLabel(" Scan")
        scan_label.setObjectName("scanTitle")
        title_layout.addWidget(scan_label)


        center_layout.addLayout(title_layout)


        # Add spacing after title
        center_layout.addSpacing(5)


        # Description with better styling
        desc_label = QLabel("Lindungi perangkat Anda dengan sistem deteksi malware\nbertenaga AI yang canggih dan akurat.")
        desc_label.setObjectName("descriptionText")
        desc_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        desc_label.setWordWrap(True)
        desc_label.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Minimum)
        center_layout.addWidget(desc_label)


        content_layout.addStretch(2)
        content_layout.addLayout(center_layout)
        content_layout.addStretch(1)


        # Action buttons with better spacing
        buttons_layout = QHBoxLayout()
        buttons_layout.setSpacing(25)
        buttons_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)


        self.update_btn = QPushButton("üìß\nPembaruan")
        self.update_btn.setObjectName("actionButton")
        self.update_btn.setFixedSize(165, 90)
        self.update_btn.clicked.connect(self.show_update_info)
        self.update_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        buttons_layout.addWidget(self.update_btn)


        self.malware_btn = QPushButton("ü¶†\nPemindai Malware")
        self.malware_btn.setObjectName("actionButton")
        self.malware_btn.setFixedSize(165, 90)
        self.malware_btn.clicked.connect(self.run_scanner)
        self.malware_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        buttons_layout.addWidget(self.malware_btn)


        self.protection_btn = QPushButton("üõ°Ô∏è\nPerlindungan Realtime")
        self.protection_btn.setObjectName("actionButton")
        self.protection_btn.setFixedSize(165, 90)
        self.protection_btn.clicked.connect(self.show_protection_info)
        self.protection_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        buttons_layout.addWidget(self.protection_btn)


        content_layout.addLayout(buttons_layout)
        content_layout.addStretch(2)


        main_layout.addWidget(content)

    def show_menu(self):
        """Handle menu button click"""
        QMessageBox.information(
            self, "Menu",
            "Menu akan segera hadir!\n\nFitur:\n- Pengaturan\n- Riwayat Scan\n- Tentang"
        )

    def on_dark_mode_toggle(self, is_dark):
        """Handle dark mode toggle dari navbar"""
        self.is_dark_mode = is_dark
        self.apply_mango_theme()
        
        # Update scan dialog jika ada
        if self.scan_dialog:
            self.scan_dialog.apply_style(is_dark)
        
        # Update navbar
        self.navbar.apply_style(is_dark)


    def apply_mango_theme(self):
        """Apply Modern MangoDefend theme with improved UI"""
        if self.is_dark_mode:
            self.setStyleSheet("""
                /* DARK MODE - Modern & Clean */
                 QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #113736, stop:1 #04080b);
            }

            QLabel#scanIcon {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #FF8C00, stop:0.3 #FFA500, stop:0.7 #FFB732, stop:1 #32CD32);
                border-radius: 65px;
                font-size: 56px;
                color: white;
                border: 4px solid rgba(255, 165, 0, 0.3);
                padding: 5px;
            }

            QLabel#mainTitle {
                color: #FFFFFF;
                font-size: 42px;
                font-weight: 700;
                font-family: 'Segoe UI', Arial, sans-serif;
                letter-spacing: 1px;
            }

            QLabel#smartTitle {
                color: #FFA500;
                font-size: 42px;
                font-weight: 700;
                font-family: 'Segoe UI', Arial, sans-serif;
                letter-spacing: 1px;
            }

            QLabel#scanTitle {
                color: #32CD32;
                font-size: 42px;
                font-weight: 700;
                font-family: 'Segoe UI', Arial, sans-serif;
                letter-spacing: 1px;
            }

            QLabel#descriptionText {
                color: #CCCCCC;
                font-size: 17px;
                font-family: 'Segoe UI', Arial, sans-serif;
                max-width: 600px;
                line-height: 1.6;
            }

            QPushButton#actionButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(40, 40, 40, 0.95), stop:1 rgba(30, 30, 30, 0.95));
                border: 3px solid #FFA500;
                border-radius: 16px;
                color: #FFA500;
                font-size: 13px;
                font-weight: 600;
                padding: 15px 10px;
                font-family: 'Segoe UI', Arial, sans-serif;
            }

            QPushButton#actionButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FFA500, stop:1 #FF8C00);
                color: white;
                border: 3px solid #FFB732;
            }

            QPushButton#actionButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #FF8C00, stop:1 #FF7F00);
                border: 3px solid #FF8C00;
                }
            """)
        else:
            self.setStyleSheet("""
                /* LIGHT MODE - Modern & Vibrant */
                QMainWindow {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 #FFF5E6, stop:0.5 #FFE4B5, stop:1 #FFDAB9);
                }


                QLabel#scanIcon {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                        stop:0 #FF8C00, stop:0.3 #FFA500, stop:0.7 #FFD700, stop:1 #32CD32);
                    border-radius: 65px;
                    font-size: 56px;
                    color: white;
                    border: 4px solid rgba(255, 140, 0, 0.4);
                    padding: 5px;
                }


                QLabel#mainTitle {
                    color: #2C2C2C;
                    font-size: 42px;
                    font-weight: 700;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    letter-spacing: 1px;
                }


                QLabel#smartTitle {
                    color: #FF8C00;
                    font-size: 42px;
                    font-weight: 700;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    letter-spacing: 1px;
                }


                QLabel#scanTitle {
                    color: #228B22;
                    font-size: 42px;
                    font-weight: 700;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    letter-spacing: 1px;
                }


                QLabel#descriptionText {
                    color: #444444;
                    font-size: 17px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    max-width: 600px;
                    line-height: 1.6;
                }


                QPushButton#actionButton {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 rgba(255, 255, 255, 0.95), stop:1 rgba(255, 250, 240, 0.95));
                    border: 3px solid #FF8C00;
                    border-radius: 16px;
                    color: #2C2C2C;
                    font-size: 13px;
                    font-weight: 600;
                    padding: 15px 10px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }


                QPushButton#actionButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #FFA500, stop:1 #FF8C00);
                    color: white;
                    border: 3px solid #FFB732;
                }


                QPushButton#actionButton:pressed {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #FF8C00, stop:1 #FF7F00);
                    border: 3px solid #FF8C00;
                }
            """)


    def run_scanner(self):
        """Start malware scanner"""
        if self.is_scanning:
            return


        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Pilih File untuk di-Scan",
            "",
            "Semua File (*.*);;Executable (*.exe *.dll);;Archives (*.zip *.rar)"
        )


        if not file_path:
            return


        # Validate file
        if not Path(file_path).exists():
            QMessageBox.critical(self, "Error", "File tidak ditemukan!")
            return


        # Check file size
        file_size = Path(file_path).stat().st_size
        if file_size > 10 * 1024 * 1024:
            QMessageBox.warning(
                self, "File Terlalu Besar",
                f"Ukuran file melebihi batas 10 MB.\nUkuran: {file_size / (1024*1024):.2f} MB"
            )
            return


        self.current_file = file_path
        self.start_scan()


    def start_scan(self):
        """Start scanning process"""
        self.is_scanning = True


        # Create scanning overlay
        if not self.scan_dialog:
            self.scan_dialog = ScanningDialog(self.centralWidget())
            self.scan_dialog.set_cancel_callback(self.cancel_scan)


        self.scan_dialog.setGeometry(self.centralWidget().rect())
        self.scan_dialog.start()


        # Start scan worker
        self.scan_worker = ScanThread(self.current_file)
        self.scan_worker.progress.connect(self.update_scan_progress)
        self.scan_worker.finished.connect(self.scan_finished)
        self.scan_worker.error.connect(self.scan_error)
        self.scan_worker.start()


    def update_scan_progress(self, value, message):
        """Update progress"""
        if self.scan_dialog and self.scan_dialog.isVisible():
            self.scan_dialog.update_progress(value, message)


    def scan_finished(self, result):
        """Handle scan completion"""
        self.is_scanning = False


        if self.scan_dialog:
            self.scan_dialog.finish()


        self.scan_history.append(result)


        # Show custom result dialog
        self.result_dialog = ResultDialog(result, self.centralWidget())
        self.result_dialog.show_dialog()


        self.cleanup_scan_worker()


    def scan_error(self, error_msg):
        """Handle scan error"""
        self.is_scanning = False


        if self.scan_dialog:
            self.scan_dialog.finish()


        QMessageBox.critical(
            self, "‚ùå Error Pemindaian",
            f"Terjadi kesalahan saat memindai:\n\n{error_msg}\n\nSilakan coba lagi."
        )


        self.cleanup_scan_worker()


    def cancel_scan(self):
        """Cancel scanning"""
        if self.scan_worker:
            self.scan_worker.cancel()


        if self.scan_dialog:
            self.scan_dialog.finish()


        self.is_scanning = False
        self.cleanup_scan_worker()


        QMessageBox.information(self, "Dibatalkan", "Pemindaian telah dibatalkan.")


    def cleanup_scan_worker(self):
        """Cleanup scan worker"""
        if self.scan_worker:
            if self.scan_worker.isRunning():
                self.scan_worker.quit()
                self.scan_worker.wait(2000)
            self.scan_worker = None


    def show_update_info(self):
        QMessageBox.information(
            self, "üìß Pembaruan",
            "Fitur pembaruan otomatis akan segera hadir!\n\nSaat ini aplikasi menggunakan model terbaru."
        )


    def show_protection_info(self):
        QMessageBox.information(
            self, "üõ°Ô∏è Perlindungan Realtime",
            "Fitur perlindungan realtime akan segera hadir!\n\nSaat ini Anda dapat memindai file secara manual."
        )


    def resizeEvent(self, event):
        """Handle window resize"""
        super().resizeEvent(event)


        # Update scan dialog geometry
        if self.scan_dialog:
            self.scan_dialog.setGeometry(self.centralWidget().rect())
            if self.scan_dialog.isVisible():
                self.scan_dialog.raise_()
